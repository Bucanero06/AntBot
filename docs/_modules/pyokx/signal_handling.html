<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyokx.signal_handling &mdash; AntBot 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AntBot
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../autodocumentation_python.html">autodocumentation_python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs.source.conf.html">docs.source.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../firebase_tools.BaseClasses.html">firebase_tools.BaseClasses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../firebase_tools.FirestoreClient.html">firebase_tools.FirestoreClient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../firebase_tools.authenticate.html">firebase_tools.authenticate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../h2o_dashboard.dashboard.html">h2o_dashboard.dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../h2o_dashboard.pages.home_page.html">h2o_dashboard.pages.home_page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../h2o_dashboard.pages.okx_debug_page.html">h2o_dashboard.pages.okx_debug_page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../h2o_dashboard.redis_connection.html">h2o_dashboard.redis_connection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../h2o_dashboard.util.html">h2o_dashboard.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../h2o_dashboard.wave_auth.html">h2o_dashboard.wave_auth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.Futures_Exchange_Client.html">pyokx.Futures_Exchange_Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.data_structures.html">pyokx.data_structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Account.html">pyokx.low_rest_api.Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.BlockTrading.html">pyokx.low_rest_api.BlockTrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Convert.html">pyokx.low_rest_api.Convert</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.CopyTrading.html">pyokx.low_rest_api.CopyTrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Earning.html">pyokx.low_rest_api.Earning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.FDBroker.html">pyokx.low_rest_api.FDBroker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Funding.html">pyokx.low_rest_api.Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Grid.html">pyokx.low_rest_api.Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.MarketData.html">pyokx.low_rest_api.MarketData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.NDBroker.html">pyokx.low_rest_api.NDBroker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.PublicData.html">pyokx.low_rest_api.PublicData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.SpreadTrading.html">pyokx.low_rest_api.SpreadTrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Status.html">pyokx.low_rest_api.Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.SubAccount.html">pyokx.low_rest_api.SubAccount</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.Trade.html">pyokx.low_rest_api.Trade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.TradingData.html">pyokx.low_rest_api.TradingData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.client.html">pyokx.low_rest_api.client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.consts.html">pyokx.low_rest_api.consts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.exceptions.html">pyokx.low_rest_api.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.low_rest_api.utils.html">pyokx.low_rest_api.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.market_data_service.WssMarketDataService.html">pyokx.okx_market_maker.market_data_service.WssMarketDataService</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.market_data_service.model.Instrument.html">pyokx.okx_market_maker.market_data_service.model.Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.market_data_service.model.MarkPx.html">pyokx.okx_market_maker.market_data_service.model.MarkPx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.market_data_service.model.OrderBook.html">pyokx.okx_market_maker.market_data_service.model.OrderBook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.market_data_service.model.Tickers.html">pyokx.okx_market_maker.market_data_service.model.Tickers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.order_management_service.WssOrderManagementService.html">pyokx.okx_market_maker.order_management_service.WssOrderManagementService</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.order_management_service.model.Order.html">pyokx.okx_market_maker.order_management_service.model.Order</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.order_management_service.model.OrderRequest.html">pyokx.okx_market_maker.order_management_service.model.OrderRequest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.position_management_service.WssPositionManagementService.html">pyokx.okx_market_maker.position_management_service.WssPositionManagementService</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.position_management_service.model.Account.html">pyokx.okx_market_maker.position_management_service.model.Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.position_management_service.model.BalanceAndPosition.html">pyokx.okx_market_maker.position_management_service.model.BalanceAndPosition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.position_management_service.model.Positions.html">pyokx.okx_market_maker.position_management_service.model.Positions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.run_sample_market_maker.html">pyokx.okx_market_maker.run_sample_market_maker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.settings.html">pyokx.okx_market_maker.settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.BaseStrateg.html">pyokx.okx_market_maker.strategy.BaseStrateg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.SampleMM.html">pyokx.okx_market_maker.strategy.SampleMM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.model.StrategyMeasurement.html">pyokx.okx_market_maker.strategy.model.StrategyMeasurement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.model.StrategyOrder.html">pyokx.okx_market_maker.strategy.model.StrategyOrder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.params.ParamsLoader.html">pyokx.okx_market_maker.strategy.params.ParamsLoader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.risk.RiskCalculator.html">pyokx.okx_market_maker.strategy.risk.RiskCalculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.strategy.risk.RiskSnapshot.html">pyokx.okx_market_maker.strategy.risk.RiskSnapshot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.tests.test_strateg.html">pyokx.okx_market_maker.tests.test_strateg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.utils.InstrumentUtil.html">pyokx.okx_market_maker.utils.InstrumentUtil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.utils.OkxEnum.html">pyokx.okx_market_maker.utils.OkxEnum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.utils.TdModeUtil.html">pyokx.okx_market_maker.utils.TdModeUtil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.okx_market_maker.utils.WsOrderUtil.html">pyokx.okx_market_maker.utils.WsOrderUtil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.redis_structured_reports.html">pyokx.redis_structured_reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.redis_structured_streams.html">pyokx.redis_structured_streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.signal_handling.html">pyokx.signal_handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.strategy_handling.html">pyokx.strategy_handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.AccountTest.html">pyokx.test.AccountTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.BlockTradingTest.html">pyokx.test.BlockTradingTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.BrokerTest.html">pyokx.test.BrokerTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.ConvertTest.html">pyokx.test.ConvertTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.CopyTradingTest.html">pyokx.test.CopyTradingTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.EarningTest.html">pyokx.test.EarningTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.FundingTest.html">pyokx.test.FundingTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.GridTest.html">pyokx.test.GridTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.MarketTest.html">pyokx.test.MarketTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.PublicDataTest.html">pyokx.test.PublicDataTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.SpreadTest.html">pyokx.test.SpreadTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.StackingTest.html">pyokx.test.StackingTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.SubAccountTest.html">pyokx.test.SubAccountTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.TradeTest.html">pyokx.test.TradeTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.TradingDataTest.html">pyokx.test.TradingDataTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.WsPrivateAsyncTest.html">pyokx.test.WsPrivateAsyncTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.test.WsPublicAsyncTest.html">pyokx.test.WsPublicAsyncTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.websocket_handling.html">pyokx.websocket_handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.ws_clients.WebSocketFactor.html">pyokx.ws_clients.WebSocketFactor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.ws_clients.WsPprivateAsync.html">pyokx.ws_clients.WsPprivateAsync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.ws_clients.WsPublicAsync.html">pyokx.ws_clients.WsPublicAsync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.ws_clients.WsUtils.html">pyokx.ws_clients.WsUtils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyokx.ws_data_structures.html">pyokx.ws_data_structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.lua_scripts.html">redis_tools._shared.lua_scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.model.base.html">redis_tools._shared.model.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.model.delete_utils.html">redis_tools._shared.model.delete_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.model.insert_utils.html">redis_tools._shared.model.insert_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.model.prop_utils.html">redis_tools._shared.model.prop_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.model.select_utils.html">redis_tools._shared.model.select_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.store.html">redis_tools._shared.store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools._shared.utils.html">redis_tools._shared.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools.asyncio.model.html">redis_tools.asyncio.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools.asyncio.store.html">redis_tools.asyncio.store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools.config.html">redis_tools.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools.syncio.model.html">redis_tools.syncio.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools.syncio.store.html">redis_tools.syncio.store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis_tools.utils.html">redis_tools.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.api_keys.html">routers.api_keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.login.html">routers.login</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.okx.html">routers.okx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.okx_authentication.html">routers.okx_authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.signu.html">routers.signu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.command_execution.html">shared.command_execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.config.html">shared.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.configuration_parser.html">shared.configuration_parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.data_processing_utils.html">shared.data_processing_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.file_directory_ops.html">shared.file_directory_ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.logging.html">shared.logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.string_dict_utils.html">shared.string_dict_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.tmp_shared.html">shared.tmp_shared</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../websocket_a.html">websocket_a</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AntBot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyokx.signal_handling</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyokx.signal_handling</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">dotenv</span>

<span class="kn">from</span> <span class="nn">pyokx.data_structures</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="n">Cancelled_Order</span><span class="p">,</span> <span class="n">Order_Placement_Return</span><span class="p">,</span>
                                   <span class="n">Position</span><span class="p">,</span> <span class="n">Closed_Position</span><span class="p">,</span> <span class="n">Ticker</span><span class="p">,</span>
                                   <span class="n">Algo_Order</span><span class="p">,</span> <span class="n">Algo_Order_Placement_Return</span><span class="p">,</span>
                                   <span class="n">AccountBalanceDetails</span><span class="p">,</span> <span class="n">AccountBalanceData</span><span class="p">,</span>
                                   <span class="n">AccountConfigData</span><span class="p">,</span> <span class="n">MaxOrderSizeData</span><span class="p">,</span> <span class="n">MaxAvailSizeData</span><span class="p">,</span> <span class="n">Cancelled_Algo_Order</span><span class="p">,</span>
                                   <span class="n">Instrument</span><span class="p">,</span> <span class="n">InstType</span><span class="p">,</span> <span class="n">Orderbook_Snapshot</span><span class="p">,</span> <span class="n">Bid</span><span class="p">,</span> <span class="n">Ask</span><span class="p">,</span>
                                   <span class="n">Simplified_Balance_Details</span><span class="p">,</span> <span class="n">InstrumentStatusReport</span><span class="p">,</span>
                                   <span class="n">PremiumIndicatorSignalRequestForm</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">redis_tools.utils</span> <span class="kn">import</span> <span class="n">serialize_for_redis</span><span class="p">,</span> <span class="n">connect_to_redis</span>
<span class="kn">from</span> <span class="nn">shared.tmp_shared</span> <span class="kn">import</span> <span class="n">calculate_tp_stop_prices</span><span class="p">,</span> <span class="n">calculate_sl_stop_prices</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">,</span> <span class="n">execute_function_calls</span>

<span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">(</span><span class="n">dotenv</span><span class="o">.</span><span class="n">find_dotenv</span><span class="p">())</span>
<span class="kn">from</span> <span class="nn">pyokx.Futures_Exchange_Client</span> <span class="kn">import</span> <span class="n">OKX_Futures_Exchange_Client</span> <span class="k">as</span> <span class="n">OKXClient</span>

<span class="n">okx_client</span> <span class="o">=</span> <span class="n">OKXClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;OKX_API_KEY&#39;</span><span class="p">),</span> <span class="n">api_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;OKX_SECRET_KEY&#39;</span><span class="p">),</span>
                       <span class="n">passphrase</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;OKX_PASSPHRASE&#39;</span><span class="p">),</span> <span class="n">sandbox_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;OKX_SANDBOX_MODE&#39;</span><span class="p">))</span>
<span class="n">tradeAPI</span> <span class="o">=</span> <span class="n">okx_client</span><span class="o">.</span><span class="n">tradeAPI</span>
<span class="n">marketAPI</span> <span class="o">=</span> <span class="n">okx_client</span><span class="o">.</span><span class="n">marketAPI</span>
<span class="n">accountAPI</span> <span class="o">=</span> <span class="n">okx_client</span><span class="o">.</span><span class="n">accountAPI</span>
<span class="n">publicAPI</span> <span class="o">=</span> <span class="n">okx_client</span><span class="o">.</span><span class="n">publicAPI</span>

<span class="n">DATA_STRUCTURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Order</span><span class="p">,</span> <span class="n">Cancelled_Order</span><span class="p">,</span> <span class="n">Order_Placement_Return</span><span class="p">,</span>
    <span class="n">Position</span><span class="p">,</span> <span class="n">Closed_Position</span><span class="p">,</span> <span class="n">Ticker</span><span class="p">,</span>
    <span class="n">Algo_Order</span><span class="p">,</span> <span class="n">Algo_Order_Placement_Return</span><span class="p">,</span>
    <span class="n">AccountBalanceDetails</span><span class="p">,</span> <span class="n">AccountBalanceData</span><span class="p">,</span>
    <span class="n">AccountConfigData</span><span class="p">,</span> <span class="n">MaxOrderSizeData</span><span class="p">,</span> <span class="n">MaxAvailSizeData</span><span class="p">,</span>
    <span class="n">Cancelled_Algo_Order</span><span class="p">,</span> <span class="n">Instrument</span><span class="p">,</span> <span class="n">InstType</span><span class="p">,</span>
    <span class="n">Orderbook_Snapshot</span><span class="p">,</span> <span class="n">Bid</span><span class="p">,</span> <span class="n">Ask</span><span class="p">,</span>
    <span class="n">Simplified_Balance_Details</span><span class="p">,</span> <span class="n">InstrumentStatusReport</span>
<span class="p">]</span>


<div class="viewcode-block" id="get_request_data">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_request_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_request_data</span><span class="p">(</span><span class="n">returned_data</span><span class="p">,</span> <span class="n">target_data_structure</span><span class="p">):</span>
    <span class="c1"># print(f&#39;{returned_data = }&#39;)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">returned_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">returned_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">returned_data</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">structured_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
        <span class="n">structured_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_data_structure</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">structured_data</span></div>



<span class="n">all_futures_instruments</span> <span class="o">=</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">publicAPI</span><span class="o">.</span><span class="n">get_instruments</span><span class="p">(</span><span class="n">instType</span><span class="o">=</span><span class="s1">&#39;FUTURES&#39;</span><span class="p">),</span>
                                           <span class="n">target_data_structure</span><span class="o">=</span><span class="n">Instrument</span><span class="p">)</span>


<div class="viewcode-block" id="InstrumentSearcher">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.InstrumentSearcher">[docs]</a>
<span class="k">class</span> <span class="nc">InstrumentSearcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Instrument</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        InstrumentSearcher is a class that allows you to search for instruments by instId, instType, or underlying</span>

<span class="sd">        :param instruments:</span>

<span class="sd">        Usage:</span>
<span class="sd">        ```</span>
<span class="sd">        instrument_searcher = InstrumentSearcher(all_futures_instruments)</span>
<span class="sd">        print(f&#39;{instrument_searcher.find_by_instId(&quot;BTC-USDT-240329&quot;) = }&#39;)</span>
<span class="sd">        print(f&#39;{instrument_searcher.find_by_type(InstType.FUTURES) = }&#39;)</span>
<span class="sd">        print(f&#39;{instrument_searcher.find_by_underlying(&quot;BTC-USDT&quot;) = }&#39;)</span>
<span class="sd">        print(f&#39;{&quot;BTC-USDT-240329&quot; in instrument_searcher._instrument_map = }&#39;)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="n">instruments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_map</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Instrument</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Instrument</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a map for quicker search by instId &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">instrument</span><span class="o">.</span><span class="n">instId</span><span class="p">:</span> <span class="n">instrument</span> <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">}</span>

<div class="viewcode-block" id="InstrumentSearcher.find_by_instId">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.InstrumentSearcher.find_by_instId">[docs]</a>
    <span class="k">def</span> <span class="nf">find_by_instId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Instrument</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find an instrument by its instId &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instId</span><span class="p">)</span></div>


<div class="viewcode-block" id="InstrumentSearcher.find_by_type">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.InstrumentSearcher.find_by_type">[docs]</a>
    <span class="k">def</span> <span class="nf">find_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instType</span><span class="p">:</span> <span class="n">InstType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Instrument</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find all instruments of a specific type &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">instrument</span> <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instType</span> <span class="o">==</span> <span class="n">instType</span><span class="p">]</span></div>


<div class="viewcode-block" id="InstrumentSearcher.find_by_underlying">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.InstrumentSearcher.find_by_underlying">[docs]</a>
    <span class="k">def</span> <span class="nf">find_by_underlying</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">underlying</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Instrument</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find all instruments of a specific underlying &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">instrument</span> <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">uly</span> <span class="o">==</span> <span class="n">underlying</span><span class="p">]</span></div>
</div>



<span class="n">instrument_searcher</span> <span class="o">=</span> <span class="n">InstrumentSearcher</span><span class="p">(</span><span class="n">all_futures_instruments</span><span class="p">)</span>


<div class="viewcode-block" id="get_ticker_with_higher_volume">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_ticker_with_higher_volume">[docs]</a>
<span class="k">def</span> <span class="nf">get_ticker_with_higher_volume</span><span class="p">(</span><span class="n">seed_symbol_name</span><span class="p">,</span> <span class="n">instrument_type</span><span class="o">=</span><span class="s2">&quot;FUTURES&quot;</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">seed_symbol_name</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># tickers_data = okx_client.marketAPI.get_tickers(instType=instrument_type)</span>

    <span class="c1"># raise DeprecationWarning(&quot;This function is deprecated. Waiting to update to Structured Data Types.&quot;)</span>
    <span class="n">all_positions</span> <span class="o">=</span> <span class="n">okx_client</span><span class="o">.</span><span class="n">accountAPI</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">instType</span><span class="o">=</span><span class="n">instrument_type</span><span class="p">)</span>
    <span class="n">all_position_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">all_positions</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
    <span class="n">tickers_data</span> <span class="o">=</span> <span class="n">okx_client</span><span class="o">.</span><span class="n">marketAPI</span><span class="o">.</span><span class="n">get_tickers</span><span class="p">(</span><span class="n">instType</span><span class="o">=</span><span class="n">instrument_type</span><span class="p">)</span>

    <span class="c1"># If any tickers data are returned, find the ticker data for the symbol we are trading</span>
    <span class="c1"># fixme this is a hack since okx is returning multiple instId&#39;s</span>
    <span class="n">_highest_volume</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_highest_volume_ticker</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ticker_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_top_n_tickers_highest_day_volume</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ticker_data</span> <span class="ow">in</span> <span class="n">tickers_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ticker_data</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">seed_symbol_name</span><span class="p">):</span>
            <span class="n">_ticker_data</span> <span class="o">=</span> <span class="n">ticker_data</span>
            <span class="n">_volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ticker_data</span><span class="p">[</span><span class="s1">&#39;volCcy24h&#39;</span><span class="p">])</span>
            <span class="n">_top_n_tickers_highest_day_volume</span><span class="p">[</span><span class="n">_volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticker_data</span>

    <span class="c1"># sort the volumes in descending order</span>
    <span class="n">_sorted_volumes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_top_n_tickers_highest_day_volume</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_top_n_tickers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_volume</span> <span class="ow">in</span> <span class="n">_sorted_volumes</span><span class="p">:</span>
        <span class="n">_top_n_tickers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_top_n_tickers_highest_day_volume</span><span class="p">[</span><span class="n">_volume</span><span class="p">])</span>

    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_ticker_data</span> <span class="ow">in</span> <span class="n">_top_n_tickers</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]:</span>
        <span class="n">tickers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ticker</span><span class="p">(</span><span class="o">**</span><span class="n">_ticker_data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tickers</span></div>


    <span class="c1"># get the tickers for the top 5 volumes</span>


<div class="viewcode-block" id="assert_okx_account_level">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.assert_okx_account_level">[docs]</a>
<span class="k">def</span> <span class="nf">assert_okx_account_level</span><span class="p">(</span><span class="n">account_level</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]):</span>
    <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;This function is deprecated. Waiting to update to Structured Data Types.&quot;</span><span class="p">)</span>
    <span class="n">ACCLV_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Simple mode&quot;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Single-currency margin mode&quot;</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;Multi-currency margin mode&quot;</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;Portfolio margin mode&quot;</span>
    <span class="p">}</span>

    <span class="k">assert</span> <span class="n">account_level</span> <span class="ow">in</span> <span class="n">ACCLV_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Account level must be one of </span><span class="si">{</span><span class="n">ACCLV_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Set account level</span>
    <span class="n">result_set_account_level</span> <span class="o">=</span> <span class="n">accountAPI</span><span class="o">.</span><span class="n">set_account_level</span><span class="p">(</span><span class="n">acctLv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result_set_account_level</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result_set_account_level</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successful request，</span><span class="se">\n</span><span class="s2">  acctLv = &quot;</span><span class="p">,</span> <span class="n">result_set_account_level</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;acctLv&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsuccessful request，</span><span class="se">\n</span><span class="s2">  error_code = &quot;</span><span class="p">,</span> <span class="n">result_set_account_level</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="s2">&quot;, </span><span class="se">\n</span><span class="s2">  Error_message = &quot;</span><span class="p">,</span>
              <span class="n">result_set_account_level</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span>

    <span class="c1"># Get account configuration</span>
    <span class="n">result_get_account_config</span> <span class="o">=</span> <span class="n">accountAPI</span><span class="o">.</span><span class="n">get_account_config</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">result_get_account_config</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="n">acctLv</span> <span class="o">=</span> <span class="n">result_get_account_config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;acctLv&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">acctLv</span> <span class="o">==</span> <span class="n">account_level</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Account level was not set to </span><span class="si">{</span><span class="n">ACCLV_MAPPING</span><span class="p">[</span><span class="n">account_level</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsuccessful request，</span><span class="se">\n</span><span class="s2">  error_code = &quot;</span><span class="p">,</span> <span class="n">result_get_account_config</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="s2">&quot;, </span><span class="se">\n</span><span class="s2">  Error_message = &quot;</span><span class="p">,</span>
              <span class="n">result_get_account_config</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span></div>



<div class="viewcode-block" id="is_valid_alphanumeric">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.is_valid_alphanumeric">[docs]</a>
<span class="k">def</span> <span class="nf">is_valid_alphanumeric</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Validate alphanumeric strings with a maximum length &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^[a-zA-Z0-9]{1,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span></div>



<div class="viewcode-block" id="try_to_get_request_data">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.try_to_get_request_data">[docs]</a>
<span class="k">def</span> <span class="nf">try_to_get_request_data</span><span class="p">(</span><span class="n">returned_data</span><span class="p">,</span> <span class="n">data_structures_to_try</span><span class="o">=</span><span class="n">DATA_STRUCTURES</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">returned_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">returned_data</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">data_struct</span> <span class="ow">in</span> <span class="n">data_structures_to_try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">data_struct</span><span class="p">(</span><span class="o">**</span><span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">data_struct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_struct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">assert</span> <span class="n">data_struct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Could not find a valid data structure for </span><span class="si">{</span><span class="n">returned_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">orders_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
        <span class="n">order_data</span> <span class="o">=</span> <span class="n">data_struct</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="n">orders_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">orders_data</span></div>



<div class="viewcode-block" id="get_all_orders">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_all_orders">[docs]</a>
<span class="k">def</span> <span class="nf">get_all_orders</span><span class="p">(</span><span class="n">instType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">instType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instType</span>
    <span class="k">if</span> <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instId</span>
    <span class="k">return</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">tradeAPI</span><span class="o">.</span><span class="n">get_order_list</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">),</span> <span class="n">Order</span><span class="p">)</span></div>



<div class="viewcode-block" id="cancel_all_orders">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.cancel_all_orders">[docs]</a>
<span class="k">def</span> <span class="nf">cancel_all_orders</span><span class="p">(</span><span class="n">orders_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instType</span><span class="p">:</span> <span class="n">InstType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">orders_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">instType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instType</span>
        <span class="k">if</span> <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instId</span>
        <span class="n">orders_list</span> <span class="o">=</span> <span class="n">get_all_orders</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># cancelled_orders = []</span>
    <span class="n">orders_to_cancel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders_list</span><span class="p">:</span>
        <span class="n">orders_to_cancel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="c1"># Batch Cancel Orders</span>
    <span class="n">cancelled_orders</span> <span class="o">=</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">tradeAPI</span><span class="o">.</span><span class="n">cancel_multiple_orders</span><span class="p">(</span>
        <span class="n">orders_data</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;instId&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">instId</span><span class="p">,</span>
             <span class="s1">&#39;ordId&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">ordId</span><span class="p">,</span>
             <span class="p">}</span> <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders_to_cancel</span>
        <span class="p">]</span>
    <span class="p">),</span> <span class="n">Cancelled_Order</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">cancelled_orders</span></div>



<div class="viewcode-block" id="close_position">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.close_position">[docs]</a>
<span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="n">instId</span><span class="p">,</span> <span class="n">mgnMode</span><span class="p">,</span> <span class="n">posSide</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ccy</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">autoCxl</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">clOrdId</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instId&#39;</span><span class="p">:</span> <span class="n">instId</span><span class="p">,</span> <span class="s1">&#39;mgnMode&#39;</span><span class="p">:</span> <span class="n">mgnMode</span><span class="p">,</span> <span class="s1">&#39;posSide&#39;</span><span class="p">:</span> <span class="n">posSide</span><span class="p">,</span> <span class="s1">&#39;ccy&#39;</span><span class="p">:</span> <span class="n">ccy</span><span class="p">,</span> <span class="s1">&#39;autoCxl&#39;</span><span class="p">:</span> <span class="n">autoCxl</span><span class="p">,</span>
              <span class="s1">&#39;clOrdId&#39;</span><span class="p">:</span> <span class="n">clOrdId</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span><span class="p">}</span>
    <span class="kn">from</span> <span class="nn">pyokx.low_rest_api.consts</span> <span class="kn">import</span> <span class="n">CLOSE_POSITION</span>
    <span class="kn">from</span> <span class="nn">pyokx.low_rest_api.consts</span> <span class="kn">import</span> <span class="n">POST</span>
    <span class="n">closed_position_return</span> <span class="o">=</span> <span class="n">tradeAPI</span><span class="o">.</span><span class="n">_request_with_params</span><span class="p">(</span><span class="n">POST</span><span class="p">,</span> <span class="n">CLOSE_POSITION</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">closed_position_return</span></div>



<div class="viewcode-block" id="close_all_positions">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.close_all_positions">[docs]</a>
<span class="k">def</span> <span class="nf">close_all_positions</span><span class="p">(</span><span class="n">positions_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Position</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instType</span><span class="p">:</span> <span class="n">InstType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">positions_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">instType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instType</span>
        <span class="k">if</span> <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instId</span>
        <span class="n">positions_list</span> <span class="o">=</span> <span class="n">get_all_positions</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="n">functions_to_execute</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions_list</span><span class="p">:</span>
        <span class="n">functions_to_execute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">FunctionCall</span><span class="p">(</span><span class="n">close_position</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">instId</span><span class="p">,</span> <span class="n">mgnMode</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">mgnMode</span><span class="p">,</span>
                         <span class="n">posSide</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">posSide</span><span class="p">,</span> <span class="n">ccy</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">ccy</span><span class="p">,</span>
                         <span class="n">autoCxl</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="n">clOrdId</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">posId</span><span class="si">}</span><span class="s1">CLOSED&#39;</span><span class="p">,</span>
                         <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">closed_positions_return</span> <span class="o">=</span> <span class="n">execute_function_calls</span><span class="p">(</span><span class="n">functions_to_execute</span><span class="p">)</span>

    <span class="n">closed_positions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">closed_position</span> <span class="ow">in</span> <span class="n">closed_positions_return</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">closed_position</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">closed_position</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
            <span class="n">closed_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_request_data</span><span class="p">(</span><span class="n">closed_position</span><span class="p">,</span> <span class="n">Closed_Position</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">closed_positions</span></div>



<div class="viewcode-block" id="get_all_positions">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_all_positions">[docs]</a>
<span class="k">def</span> <span class="nf">get_all_positions</span><span class="p">(</span><span class="n">instType</span><span class="p">:</span> <span class="n">InstType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">instType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instType</span>
    <span class="k">if</span> <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instId</span>
    <span class="k">return</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">accountAPI</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">),</span> <span class="n">Position</span><span class="p">)</span></div>



<div class="viewcode-block" id="place_order">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.place_order">[docs]</a>
<span class="k">def</span> <span class="nf">place_order</span><span class="p">(</span><span class="n">instId</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                <span class="n">tdMode</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                <span class="n">side</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                <span class="n">ordType</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                <span class="n">sz</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                <span class="n">ccy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">clOrdId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">posSide</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">px</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">reduceOnly</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">tgtCcy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">tpTriggerPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">tpOrdPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">slTriggerPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">slOrdPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">tpTriggerPxType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">slTriggerPxType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">quickMgnType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">stpId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">stpMode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">algoClOrdId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="c1"># This one is commented out because it needs multiple TP&#39;s to work and is not</span>
                <span class="c1"># developed yet downstream</span>
                <span class="c1"># amendPxOnTriggerType: str = &#39;&#39;</span>
                <span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tradeAPI</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span>
        <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="o">=</span><span class="n">tdMode</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span> <span class="n">ordType</span><span class="o">=</span><span class="n">ordType</span><span class="p">,</span> <span class="n">sz</span><span class="o">=</span><span class="n">sz</span><span class="p">,</span>
        <span class="n">ccy</span><span class="o">=</span><span class="n">ccy</span><span class="p">,</span> <span class="n">clOrdId</span><span class="o">=</span><span class="n">clOrdId</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">posSide</span><span class="o">=</span><span class="n">posSide</span><span class="p">,</span>
        <span class="n">px</span><span class="o">=</span><span class="n">px</span><span class="p">,</span> <span class="n">reduceOnly</span><span class="o">=</span><span class="n">reduceOnly</span><span class="p">,</span> <span class="n">tgtCcy</span><span class="o">=</span><span class="n">tgtCcy</span><span class="p">,</span>
        <span class="n">tpTriggerPx</span><span class="o">=</span><span class="n">tpTriggerPx</span><span class="p">,</span> <span class="n">tpOrdPx</span><span class="o">=</span><span class="n">tpOrdPx</span><span class="p">,</span>
        <span class="n">slTriggerPx</span><span class="o">=</span><span class="n">slTriggerPx</span><span class="p">,</span> <span class="n">slOrdPx</span><span class="o">=</span><span class="n">slOrdPx</span><span class="p">,</span>
        <span class="n">tpTriggerPxType</span><span class="o">=</span><span class="n">tpTriggerPxType</span><span class="p">,</span> <span class="n">slTriggerPxType</span><span class="o">=</span><span class="n">slTriggerPxType</span><span class="p">,</span>
        <span class="n">quickMgnType</span><span class="o">=</span><span class="n">quickMgnType</span><span class="p">,</span> <span class="n">stpId</span><span class="o">=</span><span class="n">stpId</span><span class="p">,</span> <span class="n">stpMode</span><span class="o">=</span><span class="n">stpMode</span><span class="p">,</span>
        <span class="n">algoClOrdId</span><span class="o">=</span><span class="n">algoClOrdId</span><span class="p">,</span>
        <span class="c1"># This one is commented out because it needs multiple TP&#39;s to work and is not</span>
        <span class="c1"># developed yet downstream</span>
        <span class="c1"># amendPxOnTriggerType=amendPxOnTriggerType,</span>

    <span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successful order request，</span><span class="se">\n</span><span class="s2">  order_id = &quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ordId&quot;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsuccessful order request，</span><span class="se">\n</span><span class="s2">  error_code = &quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">],</span> <span class="s2">&quot;, </span><span class="se">\n</span><span class="s2">  Error_message = &quot;</span><span class="p">,</span>
              <span class="n">result</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Order_Placement_Return</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_ticker">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_ticker">[docs]</a>
<span class="k">def</span> <span class="nf">get_ticker</span><span class="p">(</span><span class="n">instId</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">marketAPI</span><span class="o">.</span><span class="n">get_ticker</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">),</span> <span class="n">Ticker</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_all_algo_orders">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_all_algo_orders">[docs]</a>
<span class="k">def</span> <span class="nf">get_all_algo_orders</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordType</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ordType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ORDER_TYPES_TO_TRY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="s1">&#39;oco&#39;</span><span class="p">,</span> <span class="s1">&#39;conditional&#39;</span><span class="p">,</span> <span class="s1">&#39;move_order_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;twap&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ORDER_TYPES_TO_TRY</span> <span class="o">=</span> <span class="p">[</span><span class="n">ordType</span><span class="p">]</span>

    <span class="c1"># orders_fetched = []</span>

    <span class="n">algo_type_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ordType</span> <span class="ow">in</span> <span class="n">ORDER_TYPES_TO_TRY</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ordType&#39;</span><span class="p">:</span> <span class="n">ordType</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instId</span>

        <span class="n">algo_type_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">FunctionCall</span><span class="p">(</span><span class="n">tradeAPI</span><span class="o">.</span><span class="n">order_algos_list</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">orders_fetched_list</span> <span class="o">=</span> <span class="n">execute_function_calls</span><span class="p">(</span><span class="n">algo_type_to_fetch</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">orders_fetched_list</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">orders_fetched</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">order_types</span> <span class="ow">in</span> <span class="n">orders_fetched_list</span><span class="p">:</span>
        <span class="n">orders_fetched</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_request_data</span><span class="p">(</span><span class="n">order_types</span><span class="p">,</span> <span class="n">Algo_Order</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">orders_fetched</span></div>



<div class="viewcode-block" id="cancel_all_algo_orders_with_params">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.cancel_all_algo_orders_with_params">[docs]</a>
<span class="k">def</span> <span class="nf">cancel_all_algo_orders_with_params</span><span class="p">(</span><span class="n">algo_orders_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Algo_Order</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordType</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">algo_orders_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ordType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;algo_orders_list or instId must be provided&#39;</span>

    <span class="k">if</span> <span class="n">algo_orders_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ordType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">instId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instId</span>
        <span class="k">if</span> <span class="n">ordType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ordType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ordType</span>
        <span class="n">algo_orders_list</span> <span class="o">=</span> <span class="n">get_all_algo_orders</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">algo_orders_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">algo_orders_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">tradeAPI</span><span class="o">.</span><span class="n">cancel_algo_order</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;algoId&#39;</span><span class="p">:</span> <span class="n">algo_order</span><span class="o">.</span><span class="n">algoId</span><span class="p">,</span>
             <span class="s1">&#39;instId&#39;</span><span class="p">:</span> <span class="n">algo_order</span><span class="o">.</span><span class="n">instId</span><span class="p">,</span>
             <span class="p">}</span> <span class="k">for</span> <span class="n">algo_order</span> <span class="ow">in</span> <span class="n">algo_orders_list</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Cancelled_Algo_Order</span><span class="p">)</span></div>



<div class="viewcode-block" id="place_algo_order">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.place_algo_order">[docs]</a>
<span class="k">def</span> <span class="nf">place_algo_order</span><span class="p">(</span>
        <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tdMode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">ordType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">sz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">ccy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">posSide</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">reduceOnly</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tpTriggerPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tpOrdPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">slTriggerPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">slOrdPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">triggerPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">orderPx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tgtCcy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">pxVar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">pxSpread</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">szLimit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">pxLimit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">timeInterval</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tpTriggerPxType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">slTriggerPxType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">callbackRatio</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">callbackSpread</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">activePx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">triggerPxType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">closeFraction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">quickMgnType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">algoClOrdId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">cxlOnClosePos</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tradeAPI</span><span class="o">.</span><span class="n">place_algo_order</span><span class="p">(</span>
        <span class="c1"># Main Order with TP and SL</span>
        <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span>
        <span class="n">tdMode</span><span class="o">=</span><span class="n">tdMode</span><span class="p">,</span>
        <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
        <span class="n">ordType</span><span class="o">=</span><span class="n">ordType</span><span class="p">,</span>
        <span class="n">sz</span><span class="o">=</span><span class="n">sz</span><span class="p">,</span>
        <span class="n">ccy</span><span class="o">=</span><span class="n">ccy</span><span class="p">,</span>
        <span class="n">posSide</span><span class="o">=</span><span class="n">posSide</span><span class="p">,</span>
        <span class="n">reduceOnly</span><span class="o">=</span><span class="n">reduceOnly</span><span class="p">,</span>
        <span class="n">tpTriggerPx</span><span class="o">=</span><span class="n">tpTriggerPx</span><span class="p">,</span> <span class="n">tpOrdPx</span><span class="o">=</span><span class="n">tpOrdPx</span><span class="p">,</span> <span class="n">slTriggerPx</span><span class="o">=</span><span class="n">slTriggerPx</span><span class="p">,</span> <span class="n">slOrdPx</span><span class="o">=</span><span class="n">slOrdPx</span><span class="p">,</span> <span class="n">triggerPx</span><span class="o">=</span><span class="n">triggerPx</span><span class="p">,</span>
        <span class="n">orderPx</span><span class="o">=</span><span class="n">orderPx</span><span class="p">,</span> <span class="n">tgtCcy</span><span class="o">=</span><span class="n">tgtCcy</span><span class="p">,</span> <span class="n">pxVar</span><span class="o">=</span><span class="n">pxVar</span><span class="p">,</span> <span class="n">pxSpread</span><span class="o">=</span><span class="n">pxSpread</span><span class="p">,</span> <span class="n">szLimit</span><span class="o">=</span><span class="n">szLimit</span><span class="p">,</span> <span class="n">pxLimit</span><span class="o">=</span><span class="n">pxLimit</span><span class="p">,</span>
        <span class="n">timeInterval</span><span class="o">=</span><span class="n">timeInterval</span><span class="p">,</span> <span class="n">tpTriggerPxType</span><span class="o">=</span><span class="n">tpTriggerPxType</span><span class="p">,</span> <span class="n">slTriggerPxType</span><span class="o">=</span><span class="n">slTriggerPxType</span><span class="p">,</span>
        <span class="n">callbackRatio</span><span class="o">=</span><span class="n">callbackRatio</span><span class="p">,</span> <span class="n">callbackSpread</span><span class="o">=</span><span class="n">callbackSpread</span><span class="p">,</span> <span class="n">activePx</span><span class="o">=</span><span class="n">activePx</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
        <span class="n">triggerPxType</span><span class="o">=</span><span class="n">triggerPxType</span><span class="p">,</span> <span class="n">closeFraction</span><span class="o">=</span><span class="n">closeFraction</span><span class="p">,</span> <span class="n">quickMgnType</span><span class="o">=</span><span class="n">quickMgnType</span><span class="p">,</span> <span class="n">algoClOrdId</span><span class="o">=</span><span class="n">algoClOrdId</span><span class="p">,</span>
        <span class="n">cxlOnClosePos</span><span class="o">=</span><span class="n">cxlOnClosePos</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successful order request，</span><span class="se">\n</span><span class="s2">  order_id = &quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;algoId&quot;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsuccessful order request，</span><span class="se">\n</span><span class="s2">  error_code = &quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">],</span> <span class="s2">&quot;, </span><span class="se">\n</span><span class="s2">  Error_message = &quot;</span><span class="p">,</span>
              <span class="n">result</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">get_request_data</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Algo_Order_Placement_Return</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_account_balance">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_account_balance">[docs]</a>
<span class="k">def</span> <span class="nf">get_account_balance</span><span class="p">():</span>
    <span class="n">account_balance</span> <span class="o">=</span> <span class="n">accountAPI</span><span class="o">.</span><span class="n">get_account_balance</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">details</span> <span class="o">=</span> <span class="n">account_balance</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span>
    <span class="n">structured_details</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">structured_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AccountBalanceDetails</span><span class="p">(</span><span class="o">**</span><span class="n">detail</span><span class="p">))</span>
    <span class="n">account_balance</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structured_details</span>
    <span class="k">return</span> <span class="n">AccountBalanceData</span><span class="p">(</span><span class="o">**</span><span class="n">account_balance</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_account_config">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_account_config">[docs]</a>
<span class="k">def</span> <span class="nf">get_account_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">AccountConfigData</span><span class="p">(</span><span class="o">**</span><span class="n">accountAPI</span><span class="o">.</span><span class="n">get_account_config</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_max_order_size">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_max_order_size">[docs]</a>
<span class="k">def</span> <span class="nf">get_max_order_size</span><span class="p">(</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MaxOrderSizeData</span><span class="p">(</span><span class="o">**</span><span class="n">accountAPI</span><span class="o">.</span><span class="n">get_max_order_size</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="o">=</span><span class="n">tdMode</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_max_avail_size">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_max_avail_size">[docs]</a>
<span class="k">def</span> <span class="nf">get_max_avail_size</span><span class="p">(</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MaxAvailSizeData</span><span class="p">(</span><span class="o">**</span><span class="n">accountAPI</span><span class="o">.</span><span class="n">get_max_avail_size</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="o">=</span><span class="n">tdMode</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="generate_random_string">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.generate_random_string">[docs]</a>
<span class="k">def</span> <span class="nf">generate_random_string</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">char_type</span><span class="o">=</span><span class="s1">&#39;alphanumeric&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum length allowed is 32&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">char_type</span> <span class="o">==</span> <span class="s1">&#39;alphanumeric&#39;</span><span class="p">:</span>
        <span class="n">char_set</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
    <span class="k">elif</span> <span class="n">char_type</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span><span class="p">:</span>
        <span class="n">char_set</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
    <span class="k">elif</span> <span class="n">char_type</span> <span class="o">==</span> <span class="s1">&#39;alphabetic&#39;</span><span class="p">:</span>
        <span class="n">char_set</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid character type. Choose &#39;alphanumeric&#39;, &#39;numeric&#39;, or &#39;alphabetic&#39;.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">char_set</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">length</span><span class="p">))</span></div>



<div class="viewcode-block" id="fetch_status_report_for_instrument">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.fetch_status_report_for_instrument">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_status_report_for_instrument</span><span class="p">(</span><span class="n">instId</span><span class="p">,</span> <span class="n">TD_MODE</span><span class="p">):</span>
    <span class="n">initial_data_pull</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_max_order_size</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="o">=</span><span class="n">TD_MODE</span><span class="p">),</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_max_avail_size</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">tdMode</span><span class="o">=</span><span class="n">TD_MODE</span><span class="p">),</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_all_positions</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">),</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_all_orders</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">),</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_all_algo_orders</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="p">(</span><span class="n">max_order_size</span><span class="p">,</span> <span class="n">max_avail_size</span><span class="p">,</span>
     <span class="n">all_positions</span><span class="p">,</span> <span class="n">all_orders</span><span class="p">,</span> <span class="n">all_algo_orders</span><span class="p">)</span> <span class="o">=</span> <span class="n">execute_function_calls</span><span class="p">(</span><span class="n">initial_data_pull</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">InstrumentStatusReport</span><span class="p">(</span>
        <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span>
        <span class="n">max_order_size</span><span class="o">=</span><span class="n">max_order_size</span><span class="p">,</span>
        <span class="n">max_avail_size</span><span class="o">=</span><span class="n">max_avail_size</span><span class="p">,</span>
        <span class="n">positions</span><span class="o">=</span><span class="n">all_positions</span><span class="p">,</span>
        <span class="n">orders</span><span class="o">=</span><span class="n">all_orders</span><span class="p">,</span>
        <span class="n">algo_orders</span><span class="o">=</span><span class="n">all_algo_orders</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="fetch_initial_data">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.fetch_initial_data">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_initial_data</span><span class="p">(</span><span class="n">TD_MODE</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">initial_data_pull</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_account_balance</span><span class="p">),</span>
        <span class="n">FunctionCall</span><span class="p">(</span><span class="n">get_account_config</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="p">(</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">account_config</span><span class="p">)</span> <span class="o">=</span> <span class="n">execute_function_calls</span><span class="p">(</span><span class="n">initial_data_pull</span><span class="p">)</span>

    <span class="n">simplified_balance_details</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Simplified_Balance_Details</span><span class="p">(</span>
            <span class="n">Currency</span><span class="o">=</span><span class="n">detail</span><span class="o">.</span><span class="n">ccy</span><span class="p">,</span>
            <span class="n">Available_Balance</span><span class="o">=</span><span class="n">detail</span><span class="o">.</span><span class="n">availBal</span><span class="p">,</span>
            <span class="n">Equity</span><span class="o">=</span><span class="n">detail</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
            <span class="n">Equity_in_USD</span><span class="o">=</span><span class="n">detail</span><span class="o">.</span><span class="n">eqUsd</span><span class="p">,</span>
            <span class="n">Frozen_Balance</span><span class="o">=</span><span class="n">detail</span><span class="o">.</span><span class="n">frozenBal</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">account_balance</span><span class="o">.</span><span class="n">details</span>
    <span class="p">]</span>

    <span class="n">instrument_status_report</span> <span class="o">=</span> <span class="n">fetch_status_report_for_instrument</span><span class="p">(</span><span class="n">instId</span><span class="p">,</span> <span class="n">TD_MODE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">simplified_balance_details</span><span class="p">,</span> <span class="n">account_config</span><span class="p">,</span> <span class="n">instrument_status_report</span></div>



<div class="viewcode-block" id="clear_orders_and_positions_for_instrument">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.clear_orders_and_positions_for_instrument">[docs]</a>
<span class="k">def</span> <span class="nf">clear_orders_and_positions_for_instrument</span><span class="p">(</span><span class="n">instId</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">close_all_positions</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">)</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">)</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">cancel_all_algo_orders_with_params</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">)</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_order_book">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.get_order_book">[docs]</a>
<span class="k">def</span> <span class="nf">get_order_book</span><span class="p">(</span><span class="n">instId</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="n">orderbook_return</span> <span class="o">=</span> <span class="n">marketAPI</span><span class="o">.</span><span class="n">get_orderbook</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">sz</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orderbook_return</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">orderbook_return</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not fetch orderbook for </span><span class="si">{</span><span class="n">instId</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">orderbook_return</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span>
    <span class="n">bids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
    <span class="n">structured_asks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">structured_bids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ask</span><span class="p">,</span> <span class="n">bid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">asks</span><span class="p">,</span> <span class="n">bids</span><span class="p">):</span>
        <span class="n">structured_asks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ask</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">ask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">quantity</span><span class="o">=</span><span class="n">ask</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">deprecated_value</span><span class="o">=</span><span class="n">ask</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">number_of_orders</span><span class="o">=</span><span class="n">ask</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">structured_bids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bid</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">bid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">quantity</span><span class="o">=</span><span class="n">bid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">deprecated_value</span><span class="o">=</span><span class="n">bid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">number_of_orders</span><span class="o">=</span><span class="n">bid</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">Orderbook_Snapshot</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">asks</span><span class="o">=</span><span class="n">structured_asks</span><span class="p">,</span> <span class="n">bids</span><span class="o">=</span><span class="n">structured_bids</span><span class="p">)</span></div>



<div class="viewcode-block" id="prepare_limit_price">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.prepare_limit_price">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_limit_price</span><span class="p">(</span><span class="n">order_book</span><span class="p">:</span> <span class="n">Orderbook_Snapshot</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">side</span><span class="p">,</span> <span class="n">reference_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">max_orderbook_price_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="p">):</span>
    <span class="k">assert</span> <span class="n">side</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">]</span>
    <span class="n">limit_price</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">reference_side</span> <span class="o">=</span> <span class="s1">&#39;asks&#39;</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="s1">&#39;bids&#39;</span>
    <span class="n">asks_or_bids</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">asks</span> <span class="k">if</span> <span class="n">reference_side</span> <span class="o">==</span> <span class="s1">&#39;asks&#39;</span> <span class="k">else</span> <span class="n">order_book</span><span class="o">.</span><span class="n">bids</span>

    <span class="n">aggregate_quantity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ask_or_bid</span> <span class="ow">in</span> <span class="n">asks_or_bids</span><span class="p">:</span>
        <span class="c1"># check that if buy order then skip if reference price is greater than ask price</span>
        <span class="c1"># check that if sell order then skip if reference price is less than bid price</span>
        <span class="n">aggregate_quantity</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="ow">and</span> <span class="n">reference_price</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">price</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span> <span class="ow">and</span> <span class="n">reference_price</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">price</span><span class="p">)):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">aggregate_quantity</span> <span class="o">&gt;=</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ask_or_bid_price: </span><span class="si">{</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">, ask_or_bid_volume: </span><span class="si">{</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Check if the price is within the range we want to place our order</span>
            <span class="c1"># get the price offset from the last price</span>
            <span class="n">price_offset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">reference_price</span><span class="p">))</span> <span class="o">/</span> <span class="n">reference_price</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">max_orderbook_price_offset</span> <span class="ow">or</span> <span class="n">price_offset</span> <span class="o">&lt;=</span> <span class="n">max_orderbook_price_offset</span><span class="p">):</span>
                <span class="n">limit_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">price_offset</span><span class="si">}</span><span class="s2">% diff between reference price: </span><span class="si">{</span><span class="n">reference_price</span><span class="si">}</span><span class="s2"> and and &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;limit price: </span><span class="si">{</span><span class="n">limit_price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Computed Limit Price </span><span class="si">{</span><span class="n">ask_or_bid</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2"> is not within the range given by&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">max_orderbook_price_offset</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; if you want to remove this check, set max_orderbook_price_offset=False&quot;</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not find a price in the orderbook that has enough volume to cover the quantity&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">limit_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="place_algo_trailing_stop_loss">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.place_algo_trailing_stop_loss">[docs]</a>
<span class="k">def</span> <span class="nf">place_algo_trailing_stop_loss</span><span class="p">(</span>
        <span class="n">instId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">tdMode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">ordType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">sz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">activePx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">posSide</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">callbackRatio</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">reduceOnly</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">algoClOrdId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">cxlOnClosePos</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">place_algo_order</span><span class="p">(</span>
        <span class="n">instId</span><span class="o">=</span><span class="n">instId</span><span class="p">,</span>
        <span class="n">tdMode</span><span class="o">=</span><span class="n">tdMode</span><span class="p">,</span>
        <span class="n">ordType</span><span class="o">=</span><span class="n">ordType</span><span class="p">,</span>
        <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
        <span class="n">sz</span><span class="o">=</span><span class="n">sz</span><span class="p">,</span>
        <span class="n">activePx</span><span class="o">=</span><span class="n">activePx</span><span class="p">,</span>
        <span class="n">posSide</span><span class="o">=</span><span class="n">posSide</span><span class="p">,</span>
        <span class="n">callbackRatio</span><span class="o">=</span><span class="n">callbackRatio</span><span class="p">,</span>
        <span class="n">reduceOnly</span><span class="o">=</span><span class="n">reduceOnly</span><span class="p">,</span>
        <span class="n">algoClOrdId</span><span class="o">=</span><span class="n">algoClOrdId</span><span class="p">,</span>
        <span class="n">cxlOnClosePos</span><span class="o">=</span><span class="n">cxlOnClosePos</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="clean_and_verify_instID">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.clean_and_verify_instID">[docs]</a>
<span class="k">def</span> <span class="nf">clean_and_verify_instID</span><span class="p">(</span><span class="n">instID</span><span class="p">):</span>
    <span class="c1"># Clean Input Data</span>
    <span class="n">instID</span> <span class="o">=</span> <span class="n">instID</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">splitted</span> <span class="o">=</span> <span class="n">instID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The Futures instrument ID must be in the format of &quot;BTC-USDT-210326&quot;. </span><span class="si">{</span><span class="n">instID</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument_searcher</span><span class="o">.</span><span class="n">find_by_instId</span><span class="p">(</span><span class="n">instID</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Instrument </span><span class="si">{</span><span class="n">instID</span><span class="si">}</span><span class="s1"> not found in </span><span class="si">{</span><span class="n">all_futures_instruments</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
    <span class="c1"># assert instrument.instType == InstType.FUTURES, f&#39;{instrument.instType = }&#39;</span>
    <span class="k">return</span> <span class="n">instID</span></div>



<div class="viewcode-block" id="okx_signal_handler">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.okx_signal_handler">[docs]</a>
<span class="k">def</span> <span class="nf">okx_signal_handler</span><span class="p">(</span>
        <span class="n">instID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">order_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">leverage</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">order_side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">order_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_orderbook_limit_price_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flip_position_if_opposite_side</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">clear_prior_to_new_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">red_button</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">order_usd_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stop_loss_trigger_percentage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">take_profit_trigger_percentage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tp_trigger_price_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stop_loss_price_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tp_price_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sl_trigger_price_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trailing_stop_activation_percentage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trailing_stop_callback_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">TD_MODE</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;isolated&#39;</span>
    <span class="n">POSSIDETYPE</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;net&#39;</span>  <span class="c1"># net or long/short, need to cancel all orders/positions to change</span>

    <span class="k">if</span> <span class="n">red_button</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">close_all_positions</span><span class="p">()</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cancel_all_orders</span><span class="p">()</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cancel_all_algo_orders_with_params</span><span class="p">()</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">get_all_positions</span><span class="p">()</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">get_all_orders</span><span class="p">()</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">get_all_algo_orders</span><span class="p">()</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">instID</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Clean Input Data</span>
    <span class="n">instID</span> <span class="o">=</span> <span class="n">clean_and_verify_instID</span><span class="p">(</span><span class="n">instID</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tp_trigger_price_type</span><span class="p">:</span>
        <span class="n">tp_trigger_price_type</span> <span class="o">=</span> <span class="s1">&#39;last&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sl_trigger_price_type</span><span class="p">:</span>
        <span class="n">sl_trigger_price_type</span> <span class="o">=</span> <span class="s1">&#39;last&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_type</span><span class="p">:</span>
        <span class="n">order_type</span> <span class="o">=</span> <span class="s1">&#39;limit&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_side</span><span class="p">:</span>
        <span class="n">order_side</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_size</span><span class="p">:</span>
        <span class="n">order_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">leverage</span><span class="p">:</span>
        <span class="n">leverage</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">max_orderbook_limit_price_offset</span><span class="p">:</span>
        <span class="n">max_orderbook_limit_price_offset</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stop_loss_trigger_percentage</span><span class="p">:</span>
        <span class="n">stop_loss_trigger_percentage</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">take_profit_trigger_percentage</span><span class="p">:</span>
        <span class="n">take_profit_trigger_percentage</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stop_loss_price_offset</span><span class="p">:</span>
        <span class="n">stop_loss_price_offset</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tp_price_offset</span><span class="p">:</span>
        <span class="n">tp_price_offset</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">trailing_stop_activation_percentage</span><span class="p">:</span>
        <span class="n">trailing_stop_activation_percentage</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">trailing_stop_callback_ratio</span><span class="p">:</span>
        <span class="n">trailing_stop_callback_ratio</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flip_position_if_opposite_side</span><span class="p">:</span>
        <span class="n">flip_position_if_opposite_side</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">clear_prior_to_new_order</span><span class="p">:</span>
        <span class="n">clear_prior_to_new_order</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">order_side</span><span class="p">:</span>
        <span class="p">(</span><span class="n">order_type</span><span class="p">,</span> <span class="n">order_side</span><span class="p">,</span>
         <span class="n">TD_MODE</span><span class="p">,</span>
         <span class="n">tp_trigger_price_type</span><span class="p">,</span> <span class="n">sl_trigger_price_type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">order_side</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                          <span class="n">TD_MODE</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">tp_trigger_price_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                          <span class="n">sl_trigger_price_type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">order_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">order_size</span><span class="p">)</span>
        <span class="n">leverage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leverage</span><span class="p">)</span>

        <span class="n">stop_loss_trigger_percentage</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span>
                <span class="n">stop_loss_trigger_percentage</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stop_loss_trigger_percentage</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">stop_loss_trigger_percentage</span><span class="p">)</span>
        <span class="n">take_profit_trigger_percentage</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">take_profit_trigger_percentage</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">take_profit_trigger_percentage</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">take_profit_trigger_percentage</span><span class="p">)</span>
        <span class="n">stop_loss_price_offset</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">stop_loss_price_offset</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stop_loss_price_offset</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">stop_loss_price_offset</span><span class="p">)</span>
        <span class="n">tp_price_offset</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">tp_price_offset</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tp_price_offset</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">tp_price_offset</span><span class="p">)</span>

        <span class="n">trailing_stop_activation_percentage</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">trailing_stop_activation_percentage</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">trailing_stop_activation_percentage</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">trailing_stop_activation_percentage</span><span class="p">)</span>
        <span class="n">trailing_stop_callback_ratio</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">trailing_stop_callback_ratio</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">trailing_stop_callback_ratio</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">trailing_stop_callback_ratio</span><span class="p">)</span>

        <span class="n">max_orderbook_limit_price_offset</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">max_orderbook_limit_price_offset</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">max_orderbook_limit_price_offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">max_orderbook_limit_price_offset</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">max_orderbook_limit_price_offset</span><span class="p">)</span>

        <span class="n">flip_position_if_opposite_side</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">flip_position_if_opposite_side</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">flip_position_if_opposite_side</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="n">flip_position_if_opposite_side</span><span class="p">)</span>

        <span class="n">take_profit_activated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stop_loss_activated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">trailing_stop_loss_activated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># TODO multiple_tp and amendPxOnTriggerType are commented out because they need multiple TP&#39;s to work and is not</span>
        <span class="c1">#   developed yet downstream</span>
        <span class="c1">#   multiple_tp = None</span>
        <span class="c1">#   amendPxOnTriggerType = None</span>
        <span class="k">if</span> <span class="n">take_profit_trigger_percentage</span> <span class="ow">or</span> <span class="n">tp_price_offset</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">take_profit_trigger_percentage</span> <span class="ow">and</span> <span class="n">tp_price_offset</span>
            <span class="n">take_profit_activated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tp_trigger_price_type</span> <span class="o">=</span> <span class="n">tp_trigger_price_type</span> <span class="ow">or</span> <span class="s1">&#39;last&#39;</span>

        <span class="k">if</span> <span class="n">stop_loss_trigger_percentage</span> <span class="ow">or</span> <span class="n">stop_loss_price_offset</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">stop_loss_trigger_percentage</span> <span class="ow">and</span> <span class="n">stop_loss_price_offset</span>
            <span class="n">stop_loss_activated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">sl_trigger_price_type</span> <span class="o">=</span> <span class="n">sl_trigger_price_type</span> <span class="ow">or</span> <span class="s1">&#39;last&#39;</span>

        <span class="k">if</span> <span class="n">trailing_stop_activation_percentage</span> <span class="ow">or</span> <span class="n">trailing_stop_callback_ratio</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">trailing_stop_callback_ratio</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;trailing_stop_callback_ratio must be provided if trailing_stop_activation_percentage is provided. </span><span class="si">{</span><span class="n">trailing_stop_callback_ratio</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
            <span class="n">trailing_stop_loss_activated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">assert</span> <span class="n">TD_MODE</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;isolated&#39;</span><span class="p">,</span> <span class="s1">&#39;crossed&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TD_MODE</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">order_side</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">order_side</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;order_side must be either &quot;buy&quot; or &quot;sell&quot; or empty. </span><span class="se">\n</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;for maintenance mode </span><span class="se">\n</span><span class="s1">      </span><span class="si">{</span><span class="n">order_side</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">stop_loss_trigger_percentage</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop_loss_trigger_percentage</span><span class="p">,</span>
                                                              <span class="nb">float</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stop_loss_trigger_percentage</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">take_profit_trigger_percentage</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">take_profit_trigger_percentage</span><span class="p">,</span>
                                                                <span class="nb">float</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">take_profit_trigger_percentage</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">stop_loss_price_offset</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop_loss_price_offset</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stop_loss_price_offset</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">tp_price_offset</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tp_price_offset</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tp_price_offset</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">stop_loss_trigger_percentage</span> <span class="ow">or</span> <span class="n">stop_loss_trigger_percentage</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stop_loss_trigger_percentage</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">take_profit_trigger_percentage</span> <span class="ow">or</span> <span class="n">take_profit_trigger_percentage</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">take_profit_trigger_percentage</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">stop_loss_price_offset</span> <span class="ow">or</span> <span class="n">stop_loss_price_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stop_loss_price_offset</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">tp_price_offset</span> <span class="ow">or</span> <span class="n">tp_price_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tp_price_offset</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">tp_trigger_price_type</span> <span class="ow">or</span> <span class="n">tp_trigger_price_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;mark&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;last&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tp_trigger_price_type</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">sl_trigger_price_type</span> <span class="ow">or</span> <span class="n">sl_trigger_price_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;mark&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;last&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sl_trigger_price_type</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>

        <span class="k">assert</span> <span class="n">order_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;post_only&#39;</span><span class="p">,</span> <span class="s1">&#39;fok&#39;</span><span class="p">,</span> <span class="s1">&#39;ioc&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">order_type</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Order size must be an integer/multiple of a lot size. </span><span class="si">{</span><span class="n">order_size</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">order_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Order size must be greater than 0. </span><span class="si">{</span><span class="n">order_size</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>

        <span class="n">generated_client_order_id</span> <span class="o">=</span> <span class="n">generate_random_string</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;alphanumeric&#39;</span><span class="p">)</span>  <span class="c1"># 6 characters for type later</span>

    <span class="k">if</span> <span class="n">clear_prior_to_new_order</span><span class="p">:</span>
        <span class="n">clear_orders_and_positions_for_instrument</span><span class="p">(</span><span class="n">instID</span><span class="p">)</span>

    <span class="p">(</span><span class="n">simplified_balance_details</span><span class="p">,</span> <span class="n">account_config</span><span class="p">,</span> <span class="n">instrument_status_report</span><span class="p">)</span> <span class="o">=</span> <span class="n">fetch_initial_data</span><span class="p">(</span><span class="n">TD_MODE</span><span class="p">,</span> <span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">leverage</span> <span class="ow">and</span> <span class="n">leverage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">accountAPI</span><span class="o">.</span><span class="n">set_leverage</span><span class="p">(</span>
            <span class="n">lever</span><span class="o">=</span><span class="n">leverage</span><span class="p">,</span>
            <span class="n">mgnMode</span><span class="o">=</span><span class="n">TD_MODE</span><span class="p">,</span>
            <span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">,</span>
            <span class="n">posSide</span><span class="o">=</span><span class="n">POSSIDETYPE</span>
        <span class="p">)</span>

    <span class="n">ticker</span> <span class="o">=</span> <span class="n">get_ticker</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
    <span class="n">ask_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">askPx</span><span class="p">)</span>
    <span class="n">bid_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">bidPx</span><span class="p">)</span>
    <span class="n">reference_price</span> <span class="o">=</span> <span class="n">ask_price</span> <span class="k">if</span> <span class="n">order_side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="n">bid_price</span>
    <span class="c1"># position = all_positions[0] if len(all_positions) &gt; 0 else None  # we are only using net so only one position</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">instrument_status_report</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">instrument_status_report</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># we are only using net so only one position</span>
    <span class="c1"># # find the set of algo orders that are the oldest</span>
    <span class="c1"># # if there are any algo orders that are not in the set of oldest algo orders, cancel them</span>
    <span class="c1"># oldest_algo_order = None</span>
    <span class="c1"># for algo_order in all_algo_orders:</span>
    <span class="c1">#     if oldest_algo_order is None:</span>
    <span class="c1">#         oldest_algo_order: Algo_Order = algo_order</span>
    <span class="c1">#     elif algo_order.cTime &lt; oldest_algo_order.cTime:</span>
    <span class="c1">#         oldest_algo_order: Algo_Order = algo_order</span>
    <span class="c1">#</span>
    <span class="c1"># oldest_algoClOrdId = oldest_algo_order.algoClOrdId.strip(&#39;TPORSL&#39;).strip(&#39;TrailS&#39;)</span>
    <span class="c1"># print(f&#39;{oldest_algoClOrdId = }&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># algo_orders_to_cancel = []</span>
    <span class="c1"># for algo_order in all_algo_orders:</span>
    <span class="c1">#     if oldest_algoClOrdId not in algo_order.algoClOrdId:</span>
    <span class="c1">#         algo_orders_to_cancel.append(algo_order)</span>
    <span class="c1"># if algo_orders_to_cancel:</span>
    <span class="c1">#     print(f&#39;Cancelling all but the oldest set of algo orders \n   {algo_orders_to_cancel = }&#39;)</span>
    <span class="c1">#     # cancelled_algo_orders = cancel_all_algo_orders_with_params(algo_orders_list=algo_orders_to_cancel)</span>
    <span class="c1"># print(f&#39;{all_algo_orders = }&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># exit()</span>
    <span class="k">if</span> <span class="n">order_side</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">:</span>
            <span class="n">position_side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># we are only using net so only one position</span>
            <span class="k">if</span> <span class="n">position_side</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Closing all positions for </span><span class="si">{</span><span class="n">instID</span><span class="w"> </span><span class="si">= }</span><span class="s1"> due to 0 net position&#39;</span><span class="p">)</span>
                <span class="n">close_all_positions</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                <span class="n">cancel_all_algo_orders_with_params</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                <span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">order_side</span> <span class="ow">and</span> <span class="n">position_side</span> <span class="o">!=</span> <span class="n">order_side</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flip_position_if_opposite_side</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flipping position from </span><span class="si">{</span><span class="n">position_side</span><span class="w"> </span><span class="si">= }</span><span class="s1"> to </span><span class="si">{</span><span class="n">order_side</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">close_all_positions</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Closed all positions for </span><span class="si">{</span><span class="n">instID</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="n">cancelled_orders</span> <span class="o">=</span> <span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling orders to flip position: </span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">cancelled_orders</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">cancelled_algo_orders</span> <span class="o">=</span> <span class="n">cancel_all_algo_orders_with_params</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling Algo orders to flip position: </span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">cancelled_algo_orders</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Closing all positions for </span><span class="si">{</span><span class="n">instID</span><span class="w"> </span><span class="si">= }</span><span class="s1"> due to </span><span class="si">{</span><span class="n">position_side</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">agg_pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">order_size</span>
                    <span class="k">if</span> <span class="n">agg_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dominant_pos_side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
                    <span class="k">elif</span> <span class="n">agg_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dominant_pos_side</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dominant_pos_side</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">dominant_pos_side</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dominant_pos_side</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dominant_pos_side</span> <span class="o">!=</span> <span class="n">order_side</span><span class="p">:</span>
                            <span class="c1"># This means that the future to be position net direction is not the same as the order side</span>
                            <span class="c1"># thus we need to cancel all orders that are not on the dominant side</span>
                            <span class="c1"># and prevent new algo orders from being placed</span>
                            <span class="n">take_profit_activated</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">stop_loss_activated</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">trailing_stop_loss_activated</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">orders_to_cancel</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">instrument_status_report</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">!=</span> <span class="n">dominant_pos_side</span><span class="p">:</span>
                                    <span class="n">orders_to_cancel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                            <span class="n">algo_orders_to_cancel</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">algo_order</span> <span class="ow">in</span> <span class="n">instrument_status_report</span><span class="o">.</span><span class="n">algo_orders</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">algo_order</span><span class="o">.</span><span class="n">side</span> <span class="o">!=</span> <span class="n">dominant_pos_side</span><span class="p">:</span>
                                    <span class="n">algo_orders_to_cancel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algo_order</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">orders_to_cancel</span><span class="p">:</span>
                                <span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">orders_list</span><span class="o">=</span><span class="n">orders_to_cancel</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling orders to prep for incoming orders: </span><span class="se">\n</span><span class="s2">&quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">orders_to_cancel</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">algo_orders_to_cancel</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">algo_orders_to_cancel</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">cancelled_algo_orders</span> <span class="o">=</span> <span class="n">cancel_all_algo_orders_with_params</span><span class="p">(</span>
                                    <span class="n">algo_orders_list</span><span class="o">=</span><span class="n">algo_orders_to_cancel</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling Algo orders to prep for incoming orders: </span><span class="se">\n</span><span class="s2">&quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">cancelled_algo_orders</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The new position will result in a net 0 after the incoming orders&#39;</span>
                              <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">position_side</span><span class="w"> </span><span class="si">= }</span><span class="s1"> and the order side is </span><span class="si">{</span><span class="n">order_side</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
                              <span class="sa">f</span><span class="s1">&#39; with </span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">pos</span><span class="w"> </span><span class="si">= }</span><span class="s1"> and </span><span class="si">{</span><span class="n">order_size</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                        <span class="n">cancel_all_algo_orders_with_params</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>

        <span class="n">order_request_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">,</span>
            <span class="n">tdMode</span><span class="o">=</span><span class="n">TD_MODE</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">order_side</span><span class="p">,</span>
            <span class="n">posSide</span><span class="o">=</span><span class="n">POSSIDETYPE</span><span class="p">,</span>
            <span class="n">ordType</span><span class="o">=</span><span class="n">order_type</span><span class="p">,</span>  <span class="c1"># post_only, limit, market</span>
            <span class="n">sz</span><span class="o">=</span><span class="n">order_size</span><span class="p">,</span>
            <span class="n">clOrdId</span><span class="o">=</span><span class="n">generated_client_order_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">order_type</span> <span class="o">!=</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
            <span class="n">order_book</span> <span class="o">=</span> <span class="n">get_order_book</span><span class="p">(</span><span class="n">instID</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
            <span class="n">limit_price</span> <span class="o">=</span> <span class="n">prepare_limit_price</span><span class="p">(</span><span class="n">order_book</span><span class="p">,</span> <span class="n">order_size</span><span class="p">,</span> <span class="n">order_side</span><span class="p">,</span> <span class="n">reference_price</span><span class="p">,</span>
                                              <span class="n">max_orderbook_price_offset</span><span class="o">=</span><span class="n">max_orderbook_limit_price_offset</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting New Target Limit Price to </span><span class="si">{</span><span class="n">limit_price</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">order_request_dict</span><span class="p">[</span><span class="s1">&#39;px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit_price</span>

        <span class="k">if</span> <span class="n">take_profit_activated</span><span class="p">:</span>
            <span class="n">stop_surplus_trigger_price</span><span class="p">,</span> <span class="n">stop_surplus_execute_price</span> <span class="o">=</span> <span class="n">calculate_tp_stop_prices</span><span class="p">(</span>
                <span class="n">reference_price</span><span class="o">=</span><span class="n">reference_price</span><span class="p">,</span> <span class="n">order_side</span><span class="o">=</span><span class="n">order_side</span><span class="p">,</span>
                <span class="n">tp_trigger_percentage</span><span class="o">=</span><span class="n">take_profit_trigger_percentage</span><span class="p">,</span>
                <span class="n">tp_price_offset</span><span class="o">=</span><span class="n">tp_price_offset</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">tpTriggerPxType</span> <span class="o">=</span> <span class="n">tp_trigger_price_type</span>
            <span class="n">order_request_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">tpTriggerPx</span><span class="o">=</span><span class="n">stop_surplus_trigger_price</span><span class="p">,</span>
                <span class="n">tpOrdPx</span><span class="o">=</span><span class="n">stop_surplus_execute_price</span><span class="p">,</span>
                <span class="n">tpTriggerPxType</span><span class="o">=</span><span class="n">tpTriggerPxType</span><span class="p">,</span>
                <span class="n">algoClOrdId</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">generated_client_order_id</span><span class="si">}</span><span class="s1">TPORSL&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">stop_loss_activated</span><span class="p">:</span>
            <span class="n">stop_loss_trigger_price</span><span class="p">,</span> <span class="n">stop_loss_execute_price</span> <span class="o">=</span> <span class="n">calculate_sl_stop_prices</span><span class="p">(</span>
                <span class="n">reference_price</span><span class="o">=</span><span class="n">reference_price</span><span class="p">,</span> <span class="n">order_side</span><span class="o">=</span><span class="n">order_side</span><span class="p">,</span>
                <span class="n">sl_trigger_percentage</span><span class="o">=</span><span class="n">stop_loss_trigger_percentage</span><span class="p">,</span>
                <span class="n">sl_price_offset</span><span class="o">=</span><span class="n">stop_loss_price_offset</span><span class="p">)</span>
            <span class="n">slTriggerPxType</span> <span class="o">=</span> <span class="n">sl_trigger_price_type</span>
            <span class="n">order_request_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">slTriggerPx</span><span class="o">=</span><span class="n">stop_loss_trigger_price</span><span class="p">,</span>
                <span class="n">slOrdPx</span><span class="o">=</span><span class="n">stop_loss_execute_price</span><span class="p">,</span>
                <span class="n">slTriggerPxType</span><span class="o">=</span><span class="n">slTriggerPxType</span><span class="p">,</span>
                <span class="n">algoClOrdId</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">generated_client_order_id</span><span class="si">}</span><span class="s1">TPORSL&#39;</span>
            <span class="p">)</span>
        <span class="n">order_placement_return</span> <span class="o">=</span> <span class="n">place_order</span><span class="p">(</span><span class="o">**</span><span class="n">order_request_dict</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">order_placement_return</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># If error, cancel all orders and exit</span>
        <span class="k">if</span> <span class="n">order_placement_return</span><span class="o">.</span><span class="n">sCode</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">order_placement_return</span><span class="o">.</span><span class="n">sMsg</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cancel_all_orders</span><span class="p">()</span>
            <span class="n">cancel_all_algo_orders_with_params</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trailing_stop_loss_activated</span><span class="p">:</span>
            <span class="n">activePx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">trailing_stop_activation_percentage</span><span class="p">:</span>
                <span class="n">activePx</span> <span class="o">=</span> <span class="n">reference_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">trailing_stop_activation_percentage</span><span class="p">)</span> <span class="k">if</span> <span class="n">order_side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> \
                    <span class="n">reference_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trailing_stop_activation_percentage</span><span class="p">)</span>
            <span class="c1"># Create Trailing Stop Loss</span>
            <span class="n">trailing_stop_order_placement_return</span> <span class="o">=</span> <span class="n">place_algo_trailing_stop_loss</span><span class="p">(</span>
                <span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">,</span>
                <span class="n">tdMode</span><span class="o">=</span><span class="n">TD_MODE</span><span class="p">,</span>
                <span class="n">ordType</span><span class="o">=</span><span class="s2">&quot;move_order_stop&quot;</span><span class="p">,</span>
                <span class="n">side</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">order_side</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                <span class="n">sz</span><span class="o">=</span><span class="n">order_size</span><span class="p">,</span>
                <span class="n">activePx</span><span class="o">=</span><span class="n">activePx</span> <span class="ow">or</span> <span class="n">reference_price</span><span class="p">,</span>
                <span class="n">posSide</span><span class="o">=</span><span class="n">POSSIDETYPE</span><span class="p">,</span>
                <span class="n">callbackRatio</span><span class="o">=</span><span class="n">trailing_stop_callback_ratio</span><span class="p">,</span>
                <span class="n">reduceOnly</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
                <span class="n">algoClOrdId</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">generated_client_order_id</span><span class="si">}</span><span class="s1">TrailS&#39;</span><span class="p">,</span>
                <span class="n">cxlOnClosePos</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">trailing_stop_order_placement_return</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maintainence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">:</span>
            <span class="n">position_side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># we are only using net so only one position</span>
            <span class="k">if</span> <span class="n">position_side</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will Attempt to close all positions for </span><span class="si">{</span><span class="n">instID</span><span class="w"> </span><span class="si">= }</span><span class="s1"> due to 0 net position&#39;</span><span class="p">)</span>
                <span class="n">close_all_positions</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">instID</span><span class="p">)</span>
                <span class="c1"># cancel_all_algo_orders_with_params(instId=instID)</span>
                <span class="c1"># cancel_all_orders(instId=instID)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">FINAL REPORT&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fetch_status_report_for_instrument</span><span class="p">(</span><span class="n">instID</span><span class="p">,</span> <span class="n">TD_MODE</span><span class="p">)</span></div>



<div class="viewcode-block" id="okx_premium_indicator">
<a class="viewcode-back" href="../../pyokx.signal_handling.html#pyokx.signal_handling.okx_premium_indicator">[docs]</a>
<span class="k">def</span> <span class="nf">okx_premium_indicator</span><span class="p">(</span><span class="n">indicator_input</span><span class="p">:</span> <span class="n">PremiumIndicatorSignalRequestForm</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">HTTPException</span>
    <span class="kn">from</span> <span class="nn">starlette</span> <span class="kn">import</span> <span class="n">status</span>
    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;credentials invalid&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">input_to_pass</span> <span class="o">=</span> <span class="n">indicator_input</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator_input</span><span class="p">,</span>
                                                               <span class="n">PremiumIndicatorSignalRequestForm</span><span class="p">)</span> <span class="k">else</span> <span class="n">indicator_input</span>
    <span class="n">indicator_input</span> <span class="o">=</span> <span class="n">PremiumIndicatorSignalRequestForm</span><span class="p">(</span><span class="o">**</span><span class="n">input_to_pass</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">jose</span> <span class="kn">import</span> <span class="n">JWTError</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">routers.okx_authentication</span> <span class="kn">import</span> <span class="n">check_token_against_instrument</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">check_token_against_instrument</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">indicator_input</span><span class="o">.</span><span class="n">InstIdAPIKey</span><span class="p">,</span>
                                               <span class="n">reference_instID</span><span class="o">=</span><span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span><span class="o">.</span><span class="n">instID</span>
                                               <span class="p">)</span>
        <span class="k">assert</span> <span class="n">valid</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;InstIdAPIKey verification failed&quot;</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">credentials_exception</span>
    <span class="c1"># except AssertionError:</span>
    <span class="c1">#     raise credentials_exception</span>
    <span class="c1"># except HTTPException:</span>
    <span class="c1">#     raise credentials_exception</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in okx_antbot_webhook: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;okx signal received but there was an exception, check the logs&quot;</span><span class="p">,</span> <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indicator_input</span><span class="o">.</span><span class="n">PremiumIndicatorSignals</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Interpret Signals</span>
        <span class="n">premium_indicator</span> <span class="o">=</span> <span class="n">indicator_input</span><span class="o">.</span><span class="n">PremiumIndicatorSignals</span>

        <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish</span><span class="p">)</span>
        <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_plus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_plus</span><span class="p">)</span>
        <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish</span><span class="p">)</span>
        <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_plus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_plus</span><span class="p">)</span>
        <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_Exit</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_Exit</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_Exit</span><span class="p">)</span>
        <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_Exit</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_Exit</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_Exit</span><span class="p">)</span>

        <span class="n">_order_side</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_close_signal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_red_button</span> <span class="o">=</span> <span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span><span class="o">.</span><span class="n">red_button</span>
        <span class="k">if</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish</span> <span class="ow">or</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_plus</span><span class="p">:</span>
            <span class="n">_order_side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
        <span class="k">elif</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish</span> <span class="ow">or</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_plus</span><span class="p">:</span>
            <span class="n">_order_side</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
        <span class="k">if</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bearish_Exit</span><span class="p">:</span>
            <span class="n">_close_signal</span> <span class="o">=</span> <span class="s1">&#39;exit_buy&#39;</span>
        <span class="k">elif</span> <span class="n">premium_indicator</span><span class="o">.</span><span class="n">Bullish_Exit</span><span class="p">:</span>
            <span class="n">_close_signal</span> <span class="o">=</span> <span class="s1">&#39;exit_sell&#39;</span>

        <span class="c1"># Get current positions</span>
        <span class="kn">from</span> <span class="nn">pyokx.signal_handling</span> <span class="kn">import</span> <span class="n">get_all_positions</span>
        <span class="n">instId_positions</span> <span class="o">=</span> <span class="n">get_all_positions</span><span class="p">(</span><span class="n">instId</span><span class="o">=</span><span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span><span class="o">.</span><span class="n">instID</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instId_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_position</span> <span class="o">=</span> <span class="n">instId_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_position_side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">current_position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">current_position</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># we are only using net so only one position</span>

            <span class="k">if</span> <span class="n">_close_signal</span><span class="p">:</span>
                <span class="n">buy_exit</span> <span class="o">=</span> <span class="n">_close_signal</span> <span class="o">==</span> <span class="s1">&#39;exit_buy&#39;</span> <span class="ow">and</span> <span class="n">current_position_side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span>
                <span class="n">sell_exit</span> <span class="o">=</span> <span class="n">_close_signal</span> <span class="o">==</span> <span class="s1">&#39;exit_sell&#39;</span> <span class="ow">and</span> <span class="n">current_position_side</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">buy_exit</span> <span class="ow">or</span> <span class="n">sell_exit</span><span class="p">):</span>
                    <span class="n">_close_signal</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO - IDEA: Logic here betweeen _close_signal and entry, if just a closing then it can be handled using market or limit orders but if it is an entry and exit then we decide depening on wehther the entry is in the same or opposite directoion and if flip on opposite order is true.</span>
        <span class="c1">#   lets assume that we are not flipping on opposite order  then cancel if entry in opposite direction and close_order then clear before starting, if just closing then trat them as an actual order which can be market post only or limits</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_order_side</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">_close_signal</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_red_button</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_order_side</span> <span class="ow">or</span> <span class="n">_close_signal</span> <span class="ow">or</span> <span class="n">_red_button</span><span class="p">:</span>
            <span class="n">okx_signal</span> <span class="o">=</span> <span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span>

            <span class="n">okx_signal</span><span class="o">.</span><span class="n">order_side</span> <span class="o">=</span> <span class="n">_order_side</span> <span class="k">if</span> <span class="n">_order_side</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">okx_signal</span><span class="o">.</span><span class="n">clear_prior_to_new_order</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">okx_signal</span><span class="o">.</span><span class="n">clear_prior_to_new_order</span> <span class="ow">or</span> <span class="n">_close_signal</span> <span class="k">else</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">_close_signal</span><span class="p">:</span>  <span class="c1"># FIXME this works for Premium indicator but might have issues if not handled in order</span>
                <span class="n">okx_signal</span><span class="o">.</span><span class="n">order_side</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;updated-</span><span class="si">{</span><span class="n">premium_indicator</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;updated-</span><span class="si">{</span><span class="n">okx_signal</span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span><span class="p">,</span> <span class="s2">&quot;OKXSignalInput is None&quot;</span>
            <span class="n">okx_signal_input</span> <span class="o">=</span> <span class="n">indicator_input</span><span class="o">.</span><span class="n">OKXSignalInput</span>
            <span class="kn">from</span> <span class="nn">pyokx.signal_handling</span> <span class="kn">import</span> <span class="n">okx_signal_handler</span>
            <span class="n">instrument_status_report</span><span class="p">:</span> <span class="n">InstrumentStatusReport</span> <span class="o">=</span> <span class="n">okx_signal_handler</span><span class="p">(</span><span class="o">**</span><span class="n">okx_signal_input</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">instrument_status_report</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">instrument_status_report</span><span class="p">,</span> <span class="s2">&quot;Instrument Status Report is None, check the Instrument ID&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;okx signal received&quot;</span><span class="p">,</span> <span class="s2">&quot;instrument_status_report&quot;</span><span class="p">:</span> <span class="n">instrument_status_report</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;okx signal received but no action taken&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in okx_premium_indicator </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;okx premium indicator signal received but not handled yet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="s2">&quot;okx premium indicator signal received but not handled yet&quot;</span>
        <span class="p">}</span>

    <span class="c1"># Update the enxchange info on the database</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;unexpected end of point??.&quot;</span><span class="p">}</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dotenv</span>

    <span class="n">TEST_FUNCTION</span> <span class="o">=</span> <span class="s1">&#39;okx_signal_handler&#39;</span>
    <span class="n">okx_signal_handler</span><span class="p">(</span><span class="n">red_button</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># todo we should only handle the relevant orders/positions</span>

    <span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">(</span><span class="n">dotenv</span><span class="o">.</span><span class="n">find_dotenv</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">TEST_FUNCTION</span> <span class="o">==</span> <span class="s1">&#39;okx_signal_handler&#39;</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">okx_signal_handler</span><span class="p">(</span>
            <span class="n">instID</span><span class="o">=</span><span class="s2">&quot;BTC-USDT-240628&quot;</span><span class="p">,</span>
            <span class="n">order_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">leverage</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">order_side</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="s2">&quot;MARKET&quot;</span><span class="p">,</span>
            <span class="n">max_orderbook_limit_price_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">flip_position_if_opposite_side</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">clear_prior_to_new_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">red_button</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="c1"># order_usd_amount=100,</span>
            <span class="n">stop_loss_price_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tp_price_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">trailing_stop_activation_percentage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">trailing_stop_callback_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">stop_loss_trigger_percentage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">take_profit_trigger_percentage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tp_trigger_price_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">sl_trigger_price_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">TEST_FUNCTION</span> <span class="o">==</span> <span class="s1">&#39;okx_premium_indicator&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../debugging_payload.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">webhook_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">webhook_payload</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">indicator_input</span> <span class="o">=</span> <span class="n">PremiumIndicatorSignalRequestForm</span><span class="p">(</span><span class="o">**</span><span class="n">webhook_payload</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">connect_to_redis</span><span class="p">()</span>

        <span class="n">redis_ready_message</span> <span class="o">=</span> <span class="n">serialize_for_redis</span><span class="p">(</span><span class="n">indicator_input</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
        <span class="n">r</span><span class="o">.</span><span class="n">xadd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;okx:webhook@premium_indicator@input&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">redis_ready_message</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">okx_premium_indicator</span><span class="p">(</span><span class="n">indicator_input</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">okx_premium_indicator</span><span class="p">(</span><span class="n">webhook_payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">r</span><span class="o">.</span><span class="n">xadd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;okx:webhook@premium_indicator@result&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">serialize_for_redis</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid test function </span><span class="si">{</span><span class="n">TEST_FUNCTION</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># okx_signal_handler(red_button=True)  # todo we should only handle the relevant orders/positions</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">response</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No response&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">InstrumentStatusReport</span><span class="p">):</span>
        <span class="n">instrument_report</span> <span class="o">=</span> <span class="n">response</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">instrument_report</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument_status_report&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instrument_report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No instument status report&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No instument status report&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">instrument_report</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">instrument_report</span><span class="o">.</span><span class="n">positions</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instrument_report</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">instrument_report</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">instrument_report</span><span class="o">.</span><span class="n">orders</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">instrument_report</span><span class="o">.</span><span class="n">algo_orders</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ruben Fernandez Carbon.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>